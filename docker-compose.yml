services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 })' >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: .
      dockerfile: deploy/backend/Dockerfile
      args:
        APP_VERSION: ${APP_VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      TRUST_PROXY: "1"
      APP_VERSION: ${APP_VERSION:-dev}
      BUILD_TIME: ${BUILD_TIME:-}
      MONGODB_URI: mongodb://mongo:27017/waraqadb
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL is required (e.g. https://your-domain)}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      JWT_EXPIRE: ${JWT_EXPIRE}

      # Email (optional but recommended for password reset & notifications)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      EMAIL_FROM: ${EMAIL_FROM}

      # Cloudinary (required if you use uploads)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      CLOUDINARY_LIBRARY_FOLDER: ${CLOUDINARY_LIBRARY_FOLDER}

      # Optional currency keys
      FIXER_API_KEY: ${FIXER_API_KEY}
      CURRENCYAPI_KEY: ${CURRENCYAPI_KEY}

      # Optional library download link signing
      LIBRARY_DOWNLOAD_SECRET: ${LIBRARY_DOWNLOAD_SECRET}

      # Persist local library assets across container rebuilds
      LIBRARY_LOCAL_ASSET_DIR: /data/library-assets
      LIBRARY_UPLOAD_TMP_DIR: /data/library-uploads
    volumes:
      - library-assets:/data/library-assets
      - library-uploads:/data/library-uploads
    depends_on:
      - mongo
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:5000/api/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12

  frontend:
    build:
      context: .
      dockerfile: deploy/frontend/Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL}
        REACT_APP_SOCKET_URL: ${REACT_APP_SOCKET_URL}
        APP_VERSION: ${APP_VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1/dashboard/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12

  nginx:
    build:
      context: .
      dockerfile: deploy/nginx/Dockerfile
    restart: unless-stopped
    environment:
      DOMAIN: ${DOMAIN}
      SERVER_NAMES: ${SERVER_NAMES}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot
    depends_on:
      - backend
      - frontend


volumes:
  mongo-data:
  library-assets:
  library-uploads:
