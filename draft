cd C:\waraqa
git status
git add -A
git commit -m "browsing + global search fixes"
git push origin main

---

---

---

cd /opt/waraqa
chmod +x deploy/scripts/deploy.sh
./deploy/scripts/deploy.sh pull

---

---

---

### Production deploy (DigitalOcean droplet) â€” safe-by-default

### Copy/paste this whole block on the droplet.

cd /opt/waraqa

set -euo pipefail

# IMPORTANT (Data safety):

# - NEVER run: `docker compose down -v` or `docker system prune --volumes`

# - MongoDB data is on a named volume mounted at /data/db

# - Library files are on named volumes mounted at /data/library-assets + /data/library-uploads

# Recommended (permissions): make library private unless user has approved access.

# Ensure your droplet .env contains:

# LIBRARY_REQUIRE_SHARE_ACCESS=true

export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
export BUILDX_NO_DEFAULT_ATTESTATIONS=1
export BUILDKIT_PROGRESS=plain

# Prevent concurrent deploys

LOCK_DIR="/tmp/waraqa-deploy.lock"
if ! mkdir "$LOCK_DIR" 2>/dev/null; then
  echo "ERROR: Another deploy appears to be running ($LOCK_DIR exists)."
exit 1
fi
trap 'rm -rf "$LOCK_DIR"' EXIT

# Record rollback point BEFORE updating code

OLD_SHA="$(git rev-parse HEAD)"

# Update code safely (no merges)

git fetch origin
git reset --hard origin/main
NEW_SHA="$(git rev-parse HEAD)"

CHANGED="$(git diff --name-only "$OLD_SHA" "$NEW_SHA" || true)"
echo "Deploying: $OLD_SHA -> $NEW_SHA"

# Validate compose file renders correctly

docker compose config -q

SERVICES=""
if printf "%s\n" "$CHANGED" | grep -qE '^(deploy/nginx/|docker-compose\.yml)'; then SERVICES="$SERVICES nginx"; fi
if printf "%s\n" "$CHANGED" | grep -qE '^(backend/|deploy/backend/)'; then SERVICES="$SERVICES backend"; fi
if printf "%s\n" "$CHANGED" | grep -qE '^(frontend/|deploy/frontend/)'; then SERVICES="$SERVICES frontend"; fi

if [ -n "$(printf "%s" "$SERVICES" | tr -d ' ')" ]; then
echo "Rebuilding services:$SERVICES"
echo "Building images (this can take a while on small droplets, especially frontend)..."
docker compose build $SERVICES
docker compose up -d $SERVICES
else
echo "No build needed; restarting containers"
docker compose up -d
fi

# Avoid "Login failed" right after deploy by waiting until backend is ready.

echo "Waiting for backend to be healthy (up to ~180s)..."
healthy="0"
for i in $(seq 1 90); do
if docker compose exec -T backend node -e "const http=require('http');const req=http.get('http://127.0.0.1:5000/api/health',r=>process.exit(r.statusCode===200?0:1));req.on('error',()=>process.exit(1));" >/dev/null 2>&1; then
healthy="1"
break
fi
sleep 2
done

if [ "$healthy" != "1" ]; then
echo "Backend did not become healthy. Showing latest logs..."
docker compose logs --tail=200 backend || true
docker compose logs --tail=200 nginx || true
echo "Rollback with: git reset --hard $OLD_SHA ; docker compose up -d --build"
exit 1
fi

# Verify Mongo + library volumes are present inside containers (non-destructive)

echo "Checking mongo volume (should NOT be empty)..."
docker compose exec -T mongo sh -lc 'du -sh /data/db || true; ls -lah /data/db | head -n 50 || true'

echo "Checking library storage mounts..."
docker compose exec -T backend sh -lc '
echo "LIBRARY_LOCAL_ASSET_DIR=${LIBRARY_LOCAL_ASSET_DIR:-}";
  test "${LIBRARY_LOCAL_ASSET_DIR:-}" = "/data/library-assets" || { echo "ERROR: LIBRARY_LOCAL_ASSET_DIR must be /data/library-assets"; exit 1; };
mkdir -p "${LIBRARY_LOCAL_ASSET_DIR}";
  touch "${LIBRARY_LOCAL_ASSET_DIR}/.write_test";
rm -f "${LIBRARY_LOCAL_ASSET_DIR}/.write_test";
du -sh "/data/library-assets" || true;
du -sh "/data/library-uploads" || true;
'

# IMPORTANT: nginx can keep stale upstream IPs after backend/frontend containers are recreated.

# Always reload/restart nginx after the deploy, and verify nginx can actually reach upstreams.

echo "Reloading nginx to refresh upstream DNS..."
docker compose exec -T nginx nginx -s reload >/dev/null 2>&1 || docker compose restart nginx

echo "Verifying nginx can reach backend + frontend..."
if ! docker compose exec -T nginx sh -lc "wget -q -O- http://backend:5000/api/health >/dev/null" >/dev/null 2>&1; then
echo "nginx -> backend failed. Showing latest logs + nginx config..."
docker compose exec -T nginx nginx -T || true
docker compose logs --tail=200 nginx || true
docker compose logs --tail=200 backend || true
echo "Rollback with: git reset --hard $OLD_SHA ; docker compose up -d --build"
exit 1
fi

if ! docker compose exec -T nginx sh -lc "wget -q --spider http://frontend:80/dashboard/" >/dev/null 2>&1; then
echo "nginx -> frontend failed. Showing latest logs + nginx config..."
docker compose exec -T nginx nginx -T || true
docker compose logs --tail=200 nginx || true
docker compose logs --tail=200 frontend || true
echo "Rollback with: git reset --hard $OLD_SHA ; docker compose up -d --build"
exit 1
fi

docker compose ps
echo "Deploy complete."
