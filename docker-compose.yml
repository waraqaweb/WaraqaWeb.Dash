services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db

  backend:
    build:
      context: .
      dockerfile: deploy/backend/Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      TRUST_PROXY: "1"
      MONGODB_URI: mongodb://mongo:27017/waraqadb
      FRONTEND_URL: ${FRONTEND_URL}
      JWT_SECRET: ${JWT_SECRET}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      JWT_EXPIRE: ${JWT_EXPIRE}

      # Email (optional but recommended for password reset & notifications)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      EMAIL_FROM: ${EMAIL_FROM}

      # Cloudinary (required if you use uploads)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      CLOUDINARY_LIBRARY_FOLDER: ${CLOUDINARY_LIBRARY_FOLDER}

      # Optional currency keys
      FIXER_API_KEY: ${FIXER_API_KEY}
      CURRENCYAPI_KEY: ${CURRENCYAPI_KEY}

      # Optional library download link signing
      LIBRARY_DOWNLOAD_SECRET: ${LIBRARY_DOWNLOAD_SECRET}
    depends_on:
      - mongo

  frontend:
    build:
      context: .
      dockerfile: deploy/frontend/Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL}
        REACT_APP_SOCKET_URL: ${REACT_APP_SOCKET_URL}
    restart: unless-stopped

  nginx:
    build:
      context: .
      dockerfile: deploy/nginx/Dockerfile
    restart: unless-stopped
    environment:
      DOMAIN: ${DOMAIN}
      SERVER_NAMES: ${SERVER_NAMES}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot
    depends_on:
      - backend
      - frontend


volumes:
  mongo-data:
